"""
KPI System - Individu√°lne ciele a hodnotenie v√Ωkonnosti
Str√°nka s city-based security a modul√°rnym dizajnom
"""

import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
from datetime import datetime
from core.kpi_manager import KPIManager
from auth.auth import get_current_user, is_admin


def render():
    """Hlavn√° KPI str√°nka"""
    
    # CSS ≈°t√Ωly
    st.markdown("""
    <style>
    .kpi-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 1rem;
        border-radius: 10px;
        color: white;
        margin-bottom: 1rem;
    }
    .metric-card {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 1rem;
        margin: 0.5rem 0;
    }
    .progress-bar {
        background-color: #e9ecef;
        border-radius: 10px;
        height: 20px;
        overflow: hidden;
    }
    .progress-fill {
        height: 100%;
        border-radius: 10px;
        transition: width 0.3s ease;
    }
    .excellent { background-color: #28a745; }
    .good { background-color: #ffc107; }
    .average { background-color: #17a2b8; }
    .poor { background-color: #dc3545; }
    </style>
    """, unsafe_allow_html=True)
    
    # Header
    st.markdown("""
    <div class="kpi-card">
        <h1>üéØ KPI Syst√©m</h1>
        <p>Individu√°lne ciele a hodnotenie v√Ωkonnosti s real-time trackingom</p>
    </div>
    """, unsafe_allow_html=True)
    
    # Inicializ√°cia
    kpi_manager = KPIManager()
    current_user = get_current_user()
    
    if not current_user:
        st.error("‚ùå Mus√≠te by≈• prihl√°sen√Ω")
        return
    
    # Admin vs Manager view
    if is_admin():
        render_admin_view(kpi_manager)
    else:
        render_manager_view(kpi_manager, current_user)


def render_admin_view(kpi_manager: KPIManager):
    """Admin pohƒæad - v≈°etky mest√° a zamestnanci"""
    
    st.subheader("üëë Admin Panel - KPI Management")
    
    # Tabs pre admin
    tab1, tab2, tab3, tab4 = st.tabs([
        "üìä Prehƒæad v≈°etk√Ωch",
        "üéØ Nastavenie cieƒæov", 
        "üìà Anal√Ωzy",
        "‚öôÔ∏è Konfigur√°cia"
    ])
    
    with tab1:
        render_admin_overview(kpi_manager)
    
    with tab2:
        render_goals_management(kpi_manager)
    
    with tab3:
        render_admin_analytics(kpi_manager)
    
    with tab4:
        render_system_config(kpi_manager)


def render_manager_view(kpi_manager: KPIManager, current_user):
    """Manager pohƒæad - len svoje mesto"""
    
    # Z√≠skaj mesto pou≈æ√≠vateƒæa
    user_city = current_user.get('cities', [''])[0] if current_user.get('cities') else ''
    
    if not user_city or user_city == 'all':
        st.error("‚ùå Nem√°te pridelen√© ≈æiadne mesto")
        return
    
    st.subheader(f"üìä KPI Dashboard - {user_city.title()}")
    
    # Tabs pre mana≈æ√©ra
    tab1, tab2, tab3 = st.tabs([
        "üéØ Moje KPI",
        "üë• T√≠m",
        "üìà Anal√Ωzy"
    ])
    
    with tab1:
        render_personal_kpis(kpi_manager, current_user['email'], user_city)
    
    with tab2:
        render_team_overview(kpi_manager, user_city)
    
    with tab3:
        render_team_analytics(kpi_manager, user_city)


def render_admin_overview(kpi_manager: KPIManager):
    """Admin prehƒæad v≈°etk√Ωch miest"""
    
    st.markdown("### üåç Glob√°lny prehƒæad")
    
    # V√Ωber mesta pre detail
    analyzer = st.session_state.get('analyzer')
    if not analyzer:
        st.error("‚ùå Analyzer nie je dostupn√Ω")
        return
        
    all_employees = analyzer.get_all_employees_summary()
    
    cities = list(set([emp.get('workplace', 'unknown').lower() for emp in all_employees]))
    cities = [c for c in cities if c != 'unknown']
    
    selected_city = st.selectbox(
        "üèôÔ∏è Vyberte mesto pre detail:",
        ["V≈°etky"] + [city.title() for city in cities]
    )
    
    if selected_city == "V≈°etky":
        # Celkov√Ω prehƒæad
        render_global_metrics(kpi_manager, cities, analyzer)
    else:
        # Konkr√©tne mesto
        render_city_detail(kpi_manager, selected_city.lower(), analyzer)


def render_global_metrics(kpi_manager: KPIManager, cities, analyzer):
    """Glob√°lne metriky v≈°etk√Ωch miest"""
    
    col1, col2, col3, col4 = st.columns(4)
    
    total_employees = 0
    total_excellent = 0
    avg_scores = []
    
    for city in cities:
        team_overview = kpi_manager.get_team_overview(city, analyzer)
        if 'error' not in team_overview:
            total_employees += team_overview.get('total_employees', 0)
            total_excellent += team_overview.get('excellent_performers', 0)
            if team_overview.get('average_score'):
                avg_scores.append(team_overview.get('average_score', 0))
    
    with col1:
        st.metric("üë• Celkom zamestnancov", total_employees)
    
    with col2:
        st.metric("üèÜ Excelentn√Ωch", f"{total_excellent}/{total_employees}")
    
    with col3:
        global_avg = sum(avg_scores) / len(avg_scores) if avg_scores else 0
        st.metric("üìä Glob√°lny priemer", f"{global_avg:.1f}%")
    
    with col4:
        success_rate = (total_excellent / total_employees * 100) if total_employees > 0 else 0
        st.metric("‚úÖ √öspe≈°nos≈•", f"{success_rate:.1f}%")
    
    # Graf porovnania miest
    if cities:
        st.markdown("---")
        render_cities_comparison_chart(kpi_manager, cities, analyzer)


def render_cities_comparison_chart(kpi_manager: KPIManager, cities, analyzer):
    """Graf porovnania miest"""
    
    st.markdown("### üèôÔ∏è Porovnanie miest")
    
    city_data = []
    for city in cities:
        team_overview = kpi_manager.get_team_overview(city, analyzer)
        if 'error' not in team_overview:
            city_data.append({
                'Mesto': city.title(),
                'Zamestnanci': team_overview.get('total_employees', 0),
                'Priemern√© sk√≥re': team_overview.get('average_score', 0),
                'Excelentn√≠': team_overview.get('excellent_performers', 0)
            })
    
    if city_data:
        df = pd.DataFrame(city_data)
        
        col1, col2 = st.columns(2)
        
        with col1:
            fig_bar = px.bar(
                df, 
                x='Mesto', 
                y='Priemern√© sk√≥re',
                title="Priemern√© KPI sk√≥re po mest√°ch",
                color='Priemern√© sk√≥re',
                color_continuous_scale='RdYlGn'
            )
            st.plotly_chart(fig_bar, use_container_width=True)
        
        with col2:
            fig_scatter = px.scatter(
                df,
                x='Zamestnanci',
                y='Excelentn√≠', 
                size='Priemern√© sk√≥re',
                title="Excelentn√≠ performers vs veƒækos≈• t√≠mu",
                hover_data=['Mesto']
            )
            st.plotly_chart(fig_scatter, use_container_width=True)


def render_city_detail(kpi_manager: KPIManager, city, analyzer):
    """Detail konkr√©tneho mesta"""
    
    st.markdown(f"### üèôÔ∏è Detail mesta: {city.title()}")
    
    team_overview = kpi_manager.get_team_overview(city, analyzer)
    
    if 'error' in team_overview:
        st.error(f"‚ùå {team_overview['error']}")
        return
    
    # Z√°kladn√© metriky
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        st.metric("üë• Zamestnanci", team_overview['total_employees'])
    
    with col2:
        st.metric("üìä Priemer", f"{team_overview['average_score']:.1f}%")
    
    with col3:
        st.metric("üèÜ Excelentn√≠", team_overview['excellent_performers'])
    
    with col4:
        success_rate = (team_overview['excellent_performers'] / team_overview['total_employees'] * 100) if team_overview['total_employees'] > 0 else 0
        st.metric("‚úÖ √öspe≈°nos≈•", f"{success_rate:.1f}%")
    
    # Detail zamestnancov
    render_employees_table(team_overview.get('employees', []))


def render_employees_table(employees):
    """Tabuƒæka zamestnancov s KPI"""
    
    if not employees:
        st.info("üìä ≈Ωiadne d√°ta o zamestnancoch")
        return
    
    st.markdown("---")
    st.markdown("### üë• Detail zamestnancov")
    
    # Pr√≠prava d√°t pre tabuƒæku
    table_data = []
    for emp in employees:
        if 'error' not in emp:
            employee_info = emp.get('employee_info', {})
            table_data.append({
                'Meno': employee_info.get('name', 'Unknown'),
                'Email': emp.get('email', ''),
                'Celkov√© sk√≥re': f"{emp.get('overall_score', 0):.1f}%",
                'Predaj (aktu√°lny)': f"{emp.get('actuals', {}).get('sales', 0):,.0f} Kƒç",
                'Predaj (progress)': f"{emp.get('progress', {}).get('sales', 0):.1f}%", 
                'Aktivita': f"{emp.get('progress', {}).get('activity', 0):.1f}%",
                'V√Ωkon': emp.get('performance_level', {}).get('label', 'N/A')
            })
    
    if table_data:
        df = pd.DataFrame(table_data)
        df = df.sort_values('Celkov√© sk√≥re', ascending=False, key=lambda x: x.str.rstrip('%').astype(float))
        st.dataframe(df, use_container_width=True)


def render_personal_kpis(kpi_manager: KPIManager, email, city):
    """Osobn√© KPI mana≈æ√©ra"""
    
    st.markdown("### üéØ Moje osobn√© KPI")
    
    # Z√≠skaj osobn√© KPI
    personal_kpis = kpi_manager.get_employee_kpis(email)
    
    if 'error' in personal_kpis:
        st.error(f"‚ùå {personal_kpis['error']}")
        return
    
    # Celkov√© sk√≥re
    overall_score = personal_kpis.get('overall_score', 0)
    performance_level = personal_kpis.get('performance_level', {})
    
    col1, col2, col3 = st.columns([2, 1, 1])
    
    with col1:
        st.markdown(f"""
        <div class="metric-card">
            <h3>üìä Celkov√© KPI sk√≥re</h3>
            <h1 style="color: {performance_level.get('color', '#333')}; margin: 0;">
                {overall_score:.1f}%
            </h1>
            <p>{performance_level.get('label', 'N/A')}</p>
        </div>
        """, unsafe_allow_html=True)
    
    with col2:
        period = personal_kpis.get('period', 'current')
        st.metric("üìÖ Obdobie", period.upper())
    
    with col3:
        last_update = personal_kpis.get('last_updated', '')
        if last_update:
            update_date = datetime.fromisoformat(last_update.replace('Z', '+00:00')).strftime('%d.%m. %H:%M')
            st.metric("üîÑ Aktualizovan√©", update_date)
    
    # Detail metr√≠k
    st.markdown("---")
    render_kpi_details(personal_kpis)


def render_kpi_details(kpis):
    """Detail jednotliv√Ωch KPI metr√≠k"""
    
    st.markdown("### üìà Detail metr√≠k")
    
    goals = kpis.get('goals', {})
    actuals = kpis.get('actuals', {})
    progress = kpis.get('progress', {})
    
    # Predajn√© KPI
    if 'sales' in goals:
        col1, col2 = st.columns(2)
        
        with col1:
            sales_goal = goals['sales']
            sales_actual = actuals.get('sales', 0)
            sales_progress = progress.get('sales', 0)
            
            st.markdown(f"""
            <div class="metric-card">
                <h4>üí∞ Predajn√© KPI</h4>
                <p><strong>Cieƒæ:</strong> {sales_goal:,} Kƒç</p>
                <p><strong>Aktu√°lne:</strong> {sales_actual:,} Kƒç</p>
                <p><strong>Progress:</strong> {sales_progress:.1f}%</p>
                <div class="progress-bar">
                    <div class="progress-fill {'excellent' if sales_progress >= 100 else 'good' if sales_progress >= 75 else 'average' if sales_progress >= 50 else 'poor'}" 
                         style="width: {min(sales_progress, 100)}%"></div>
                </div>
            </div>
            """, unsafe_allow_html=True)
        
        with col2:
            # Graf predajn√©ho trendu
            render_sales_trend_chart(kpis)
    
    # Activity KPI
    if 'activity_score' in goals:
        activity_goal = goals['activity_score']
        activity_actual = actuals.get('activity', 0)
        activity_progress = progress.get('activity', 0)
        
        st.markdown(f"""
        <div class="metric-card">
            <h4>üìä Aktivita v syst√©me</h4>
            <p><strong>Cieƒæ:</strong> {activity_goal} bodov</p>
            <p><strong>Aktu√°lne:</strong> {activity_actual} bodov</p>
            <p><strong>Progress:</strong> {activity_progress:.1f}%</p>
            <div class="progress-bar">
                <div class="progress-fill {'excellent' if activity_progress >= 100 else 'good' if activity_progress >= 75 else 'average' if activity_progress >= 50 else 'poor'}" 
                     style="width: {min(activity_progress, 100)}%"></div>
            </div>
        </div>
        """, unsafe_allow_html=True)


def render_sales_trend_chart(kpis):
    """Graf predajn√©ho trendu"""
    
    # Dummy d√°ta pre trend (nesk√¥r napoj√≠me na skutoƒçn√© d√°ta)
    months = ['Jan', 'Feb', 'Mar']
    actual_sales = [800000, 900000, 750000]  # Dummy
    target_line = [kpis.get('goals', {}).get('sales', 2000000) / 3] * 3
    
    fig = go.Figure()
    
    fig.add_trace(go.Scatter(
        x=months,
        y=actual_sales,
        mode='lines+markers',
        name='Skutoƒçn√© predaje',
        line=dict(color='#007bff', width=3)
    ))
    
    fig.add_trace(go.Scatter(
        x=months,
        y=target_line,
        mode='lines',
        name='Mesaƒçn√Ω cieƒæ',
        line=dict(color='red', dash='dash')
    ))
    
    fig.update_layout(
        title="Predajn√Ω trend",
        xaxis_title="Mesiac",
        yaxis_title="Predaj (Kƒç)",
        height=300
    )
    
    st.plotly_chart(fig, use_container_width=True)


def render_team_overview(kpi_manager: KPIManager, city):
    """Prehƒæad t√≠mu pre mana≈æ√©ra"""
    
    st.markdown(f"### üë• Prehƒæad t√≠mu - {city.title()}")
    
    analyzer = st.session_state.get('analyzer')
    if not analyzer:
        st.error("‚ùå Analyzer nie je dostupn√Ω")
        return
    
    team_overview = kpi_manager.get_team_overview(city, analyzer)
    
    if 'error' in team_overview:
        st.error(f"‚ùå {team_overview['error']}")
        return
    
    # Z√°kladn√© metriky t√≠mu
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        st.metric("üë• T√≠m", team_overview['total_employees'])
    
    with col2:
        st.metric("üìä Priemer", f"{team_overview['average_score']:.1f}%")
    
    with col3:
        st.metric("üèÜ Top performeri", team_overview['excellent_performers'])
    
    with col4:
        success_rate = (team_overview['excellent_performers'] / team_overview['total_employees'] * 100) if team_overview['total_employees'] > 0 else 0
        st.metric("‚úÖ √öspe≈°nos≈•", f"{success_rate:.1f}%")
    
    # Detail zamestnancov
    st.markdown("---")
    render_employees_table(team_overview.get('employees', []))


def render_team_analytics(kpi_manager: KPIManager, city):
    """Analytick√© pohƒæady pre t√≠m"""
    
    st.markdown(f"### üìà Analytika t√≠mu - {city.title()}")
    
    analyzer = st.session_state.get('analyzer')
    if not analyzer:
        st.error("‚ùå Analyzer nie je dostupn√Ω")
        return
    
    team_overview = kpi_manager.get_team_overview(city, analyzer)
    
    if 'error' in team_overview or not team_overview.get('employees'):
        st.info("üìä Nedostatok d√°t pre anal√Ωzu")
        return
    
    employees = team_overview['employees']
    
    # Graf distrib√∫cie v√Ωkonnosti
    performance_counts = {}
    for emp in employees:
        if 'error' not in emp:
            perf_level = emp.get('performance_level', {}).get('level', 'unknown')
            performance_counts[perf_level] = performance_counts.get(perf_level, 0) + 1
    
    if performance_counts:
        fig_pie = px.pie(
            values=list(performance_counts.values()),
            names=list(performance_counts.keys()),
            title=f"Distrib√∫cia v√Ωkonnosti - {city.title()}"
        )
        st.plotly_chart(fig_pie, use_container_width=True)


def render_goals_management(kpi_manager: KPIManager):
    """Spr√°va cieƒæov (len admin)"""
    
    st.markdown("### üéØ Spr√°va cieƒæov")
    
    goals = kpi_manager.load_goals()
    
    # Glob√°lne ciele
    st.markdown("#### üåç Glob√°lne ciele")
    
    global_targets = goals.get('global_targets', {}).get('2025', {})
    
    for period, targets in global_targets.items():
        with st.expander(f"üìÖ {period.upper()} - Ciele"):
            col1, col2 = st.columns(2)
            
            with col1:
                new_sales = st.number_input(
                    f"üí∞ Predaj {period.upper()} (Kƒç):",
                    value=targets.get('sales', 0),
                    key=f"sales_{period}"
                )
            
            with col2:
                new_activity = st.number_input(
                    f"üìä Aktivita {period.upper()} (body):",
                    value=targets.get('activity_score', 80),
                    key=f"activity_{period}"
                )
            
            if st.button(f"üíæ Ulo≈æi≈• {period.upper()}", key=f"save_{period}"):
                goals['global_targets']['2025'][period]['sales'] = new_sales
                goals['global_targets']['2025'][period]['activity_score'] = new_activity
                kpi_manager.save_goals(goals)
                st.success(f"‚úÖ Ciele pre {period.upper()} ulo≈æen√©")
                st.rerun()


def render_admin_analytics(kpi_manager: KPIManager):
    """Admin analytick√© pohƒæady"""
    
    st.markdown("### üìà Pokroƒçil√© anal√Ωzy")
    st.info("üöß Pokroƒçil√© analytick√© funkcie bud√∫ pridan√© v ƒèal≈°ej verzii")


def render_system_config(kpi_manager: KPIManager):
    """Konfigur√°cia syst√©mu"""
    
    st.markdown("### ‚öôÔ∏è Konfigur√°cia syst√©mu")
    
    metrics_config = kpi_manager.load_metrics_config()
    
    st.markdown("#### üìä Akt√≠vne metriky")
    
    for metric_key, metric_config in metrics_config['active_metrics'].items():
        with st.expander(f"{metric_config['icon']} {metric_config['name']}"):
            col1, col2, col3 = st.columns(3)
            
            with col1:
                enabled = st.checkbox(
                    "Akt√≠vna",
                    value=metric_config['enabled'],
                    key=f"enabled_{metric_key}"
                )
            
            with col2:
                weight = st.number_input(
                    "V√°ha (%)",
                    value=metric_config['weight'],
                    min_value=0,
                    max_value=100,
                    key=f"weight_{metric_key}"
                )
            
            with col3:
                if metric_config.get('note'):
                    st.info(metric_config['note'])
            
            # Mo≈ænos≈• ulo≈æenia zmien sa prid√° nesk√¥r


if __name__ == "__main__":
    render()
