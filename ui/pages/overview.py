# ui/pages/overview.py
import streamlit as st
import plotly.graph_objects as go
from core.utils import (
    format_money, format_profit_value, time_to_minutes,
    calculate_activity_breakdown, get_activity_colors, 
    categorize_activities, calculate_productivity_metrics, get_top_activities,
    create_combined_monthly_activity_chart, get_combined_monthly_activity_summary
)
from core.metrics_calculator import EmployeeMetricsCalculator
from auth.auth import filter_data_by_user_access, can_access_city, get_user_cities
from datetime import datetime
from ui.styling import (
    get_dark_plotly_layout, apply_dark_theme, create_section_header, 
    create_subsection_header, create_metric_card, create_simple_metric_card,
    create_three_column_layout
)
from core.error_handler import handle_error, log_error

@handle_error
def render(analyzer):
    """Hlavn√Ω prehƒæad dashboard s novou analyzer triedou"""
    apply_dark_theme()
    # Valid√°cia d√°t na zaƒçiatku
    analyzer.validate_sales_consistency()
    
    # Z√≠skanie s√∫hrnu
    summary = analyzer.get_all_employees_summary()
    
    if not summary:
        st.warning("‚ö†Ô∏è ≈Ωiadn√° data k zobrazen√≠")
        return
    
    # ‚úÖ NOV√â - Filtrovanie podƒæa opr√°vnen√≠ pou≈æ√≠vateƒæa
    import pandas as pd
    summary_df = pd.DataFrame(summary)
    filtered_summary_df = filter_data_by_user_access(summary_df)
    filtered_summary = filtered_summary_df.to_dict('records')
    
    # Ak po filtrovan√≠ nie s√∫ ≈æiadne d√°ta
    if not filtered_summary:
        st.warning("‚ö†Ô∏è Nem√°te opr√°vnenie na zobrazenie t√Ωchto d√°t alebo nie s√∫ dostupn√©")
        return
    
    # ≈†tatistiky podƒæa miest - s filtrovan√Ωmi d√°tami
    create_city_overview(filtered_summary)
    
    # ‚úÖ NOV√â - Mesaƒçn√Ω graf aktiv√≠t NAD vyhƒæad√°van√≠m
    st.markdown("---")
    create_monthly_activity_chart(analyzer)
    
    # ‚úÖ NOV√â - Detailn√Ω graf aktiv√≠t so skutoƒçn√Ωmi d√°tami POU≈Ω√çVAJ√öC UTILS
    with st.expander("üîç Detailn√© rozlo≈æenie aktiv√≠t", expanded=False):
        create_activity_breakdown_chart(analyzer)
    
    st.markdown("---")
    
    # Vyhƒæad√°vanie zamestnancov (p√¥vodn√©) - s filtrovan√Ωmi d√°tami
    show_employee_search(filtered_summary, analyzer)

def create_city_overview(summary_data):
    """Vytvor√≠ prehƒæad podƒæa miest"""
    
    # Pr√≠prava d√°t
    city_stats = {}
    total_sales = 0
    
    for emp in summary_data:
        city = emp['workplace']
        emp_sales = emp.get('total_sales', 0)
        total_sales += emp_sales
        
        if city not in city_stats:
            city_stats[city] = {
                'count': 0,
                'total_sales': 0,
                'excellent': 0,
                'good': 0,
                'average': 0,
                'poor': 0
            }
        
        city_stats[city]['count'] += 1
        city_stats[city]['total_sales'] += emp_sales
        city_stats[city][emp.get('rating', 'average')] += 1
    
    # V√Ωpoƒçet percent
    for city in city_stats:
        city_stats[city]['percentage'] = (city_stats[city]['total_sales'] / total_sales * 100) if total_sales > 0 else 0
        city_stats[city]['avg_score'] = city_stats[city]['total_sales'] / city_stats[city]['count'] if city_stats[city]['count'] > 0 else 0
    
    # Zobrazenie kariek miest
    create_section_header("Celkov√Ω p≈ôehled zisku podle mƒõst", "üí∞")
    
    profit_cols = st.columns(len(city_stats))
    for i, (city, stats) in enumerate(city_stats.items()):
        with profit_cols[i]:
            # Urƒçenie statusu na z√°klade priemern√©ho v√Ωkonu
            avg_performance = stats['avg_score']
            if avg_performance >= 2000000:  # 2M+
                status = "V√Ωborn√©"
                status_color = "#10b981"
                border_color = "#10b981"
            elif avg_performance >= 1500000:  # 1.5M+
                status = "Dobr√©"
                status_color = "#3b82f6"
                border_color = "#3b82f6"
            elif avg_performance >= 1000000:  # 1M+
                status = "Priemern√©"
                status_color = "#f59e0b"
                border_color = "#f59e0b"
            else:
                status = "Slab√©"
                status_color = "#ef4444"
                border_color = "#ef4444"
            
            formatted_profit = format_profit_value(stats['total_sales'], stats['percentage'])
            
            st.markdown(f"""
            <div style="
                background: linear-gradient(135deg, rgba(31, 41, 55, 0.9), rgba(55, 65, 81, 0.9));
                border-left: 4px solid {border_color};
                border-radius: 8px;
                padding: 15px;
                margin: 10px 0;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            ">
                <h5 style="color: {border_color}; margin: 0 0 10px 0; font-size: 1rem;">
                    üè¢ {city.title()}
                </h5>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 10px 0;">
                    <div>
                        <p style="color: #9ca3af; margin: 2px 0; font-size: 0.8rem;">Celkov√Ω zisk:</p>
                        <p style="color: white; margin: 2px 0; font-weight: bold; font-size: 1.2rem;">{formatted_profit}</p>
                    </div>
                    <div>
                        <p style="color: #9ca3af; margin: 2px 0; font-size: 0.8rem;">Zamestnanci:</p>
                        <p style="color: white; margin: 2px 0; font-weight: bold;">{stats['count']} os√¥b</p>
                    </div>
                </div>
                <div style="margin: 5px 0;">
                    <p style="color: #9ca3af; margin: 2px 0; font-size: 0.8rem;">Priemer na osobu:</p>
                    <p style="color: {status_color}; margin: 2px 0; font-weight: bold;">{format_money(avg_performance)}</p>
                </div>
                <div style="margin-top: 8px;">
                    <span style="
                        background: {status_color}20; 
                        color: {status_color}; 
                        padding: 2px 8px; 
                        border-radius: 12px; 
                        font-size: 0.75rem;
                        font-weight: bold;
                    ">
                        {status}
                    </span>
                    <span style="
                        background: rgba(107, 114, 128, 0.2); 
                        color: #9ca3af; 
                        padding: 2px 8px; 
                        border-radius: 12px; 
                        font-size: 0.75rem;
                        margin-left: 5px;
                    ">
                        {stats['percentage']:.1f}%
                    </span>
                </div>
            </div>
            """, unsafe_allow_html=True)
    
    # Grafy
    create_city_charts(city_stats)

def create_city_charts(city_stats):
    """Vytvor√≠ grafy pre mest√° - OPRAVEN√â bez duplicitn√Ωch title"""
    
    col1, col2 = st.columns(2)
    
    with col1:
        # Kol√°ƒçov√Ω graf
        cities = list(city_stats.keys())
        values = [city_stats[city]['total_sales'] for city in cities]
        
        fig_pie = go.Figure(data=[go.Pie(
            labels=[city.title() for city in cities],
            values=values,
            hole=0.4,
            marker_colors=['#4299e1', '#48bb78', '#ed8936', '#f56565']
        )])
        
        # ‚úÖ OPRAVEN√â: title iba v update_layout, nie duplicitn√Ω
        layout_settings = get_dark_plotly_layout()
        layout_settings.update({
            'title': {
                'text': "Rozlo≈æen√≠ zisku podle mƒõst",
                'font': {'size': 18, 'color': '#fafafa'}
            },
            'height': 400
        })
        
        fig_pie.update_layout(**layout_settings)
        
        st.plotly_chart(fig_pie, use_container_width=True)
    
    with col2:
        # Stƒ∫pcov√Ω graf
        avg_profits = [city_stats[city]['avg_score'] for city in cities]
        
        fig_bar = go.Figure(data=[go.Bar(
            x=[city.title() for city in cities],
            y=avg_profits,
            marker_color=['#4299e1', '#48bb78', '#ed8936', '#f56565'],
            text=[format_money(profit) for profit in avg_profits],
            textposition='auto'
        )])
        
        # ‚úÖ OPRAVEN√â: title iba raz, nie duplicitn√Ω
        layout_settings = get_dark_plotly_layout()
        layout_settings.update({
            'title': {
                'text': "Pr≈Ømƒõrn√Ω zisk na zamƒõstnance", 
                'font': {'size': 18, 'color': '#fafafa'}
            },
            'height': 400,
            'xaxis': {
                'title': "Mƒõsto",
                'color': '#fafafa',
                'gridcolor': '#262730'
            },
            'yaxis': {
                'title': "Pr≈Ømƒõrn√Ω zisk (Kƒç)",
                'color': '#fafafa', 
                'gridcolor': '#262730'
            }
        })
        
        fig_bar.update_layout(**layout_settings)
        
        st.plotly_chart(fig_bar, use_container_width=True)

def show_employee_search(summary_data, analyzer):
    """Vyhƒæad√°vanie zamestnancov"""
    
    create_section_header("Vyhled√°v√°n√≠ zamƒõstnanc≈Ø", "üîç")
    
    col1, col2, col3 = st.columns([2, 1, 1])
    
    with col1:
        search_term = st.text_input("Zadejte jm√©no zamƒõstnance:", placeholder="Nap≈ô. Nov√°k, Svoboda...")
    
    with col2:
        city_filter = st.selectbox("Filtr podle mƒõsta:", ["V≈°echna mƒõsta"] + [city.title() for city in ['praha', 'brno', 'zlin', 'vizovice']])
    
    with col3:
        rating_filter = st.selectbox("Filtr podle hodnocen√≠:", ["V≈°echna hodnocen√≠", "V√Ωborn√≠", "Dob≈ô√≠", "Pr≈Ømƒõrn√≠", "Podpr≈Ømƒõrn√≠"])
    
    # Filtrovanie
    filtered_data = filter_employees(summary_data, search_term, city_filter, rating_filter)
    
    # Zobrazenie v√Ωsledkov
    if filtered_data:
        st.markdown(f"**N√°jden√Ωch {len(filtered_data)} zamƒõstnanc≈Ø:**")
        show_employee_cards(filtered_data, analyzer, prefix="search")
    else:
        st.warning("‚ö†Ô∏è ≈Ω√°dn√≠ zamƒõstnanci nevyhovuj√≠ zadan√Ωm krit√©ri√≠m")

def filter_employees(summary_data, search_term, city_filter, rating_filter):
    """Filtruje zamestnancov podƒæa krit√©ri√≠"""
    
    filtered_data = summary_data.copy()
    
    if search_term:
        filtered_data = [emp for emp in filtered_data if search_term.lower() in emp['name'].lower()]
    
    if city_filter != "V≈°echna mƒõsta":
        filtered_data = [emp for emp in filtered_data if emp['workplace'].title() == city_filter]
    
    if rating_filter != "V≈°echna hodnocen√≠":
        rating_map = {"V√Ωborn√≠": "excellent", "Dob≈ô√≠": "good", "Pr≈Ømƒõrn√≠": "average", "Podpr≈Ømƒõrn√≠": "poor"}
        filtered_data = [emp for emp in filtered_data if emp.get('rating', 'average') == rating_map[rating_filter]]
    
    return filtered_data

def show_employee_cards(employees, analyzer, prefix="main"):
    """‚úÖ OPRAVEN√â - Grid layout s CSS override"""
    
    # Legenda
    show_neutral_legend()
    st.divider()
    
    # ‚úÖ SILN√ù CSS override - prep√≠≈°e styling.py
    st.markdown("""
    <style>
    /* Override styling.py with !important */
    .stButton > button {
        height: 140px !important;
        white-space: pre-wrap !important;
        text-align: center !important;
        padding: 16px 12px !important;
        font-size: 0.85rem !important;
        line-height: 1.4 !important;
        border-radius: 16px !important;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important;
        border: 2px solid transparent !important;
        position: relative !important;
        overflow: hidden !important;
    }
    
    .stButton > button:hover {
        transform: translateY(-5px) scale(1.02) !important;
        box-shadow: 0 12px 30px rgba(0,0,0,0.2) !important;
        border-color: #ffffff40 !important;
    }
    
    .stButton > button[kind="primary"] {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        color: white !important;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3) !important;
    }
    
    .stButton > button[kind="secondary"] {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%) !important;
        color: white !important;
        box-shadow: 0 4px 15px rgba(240, 147, 251, 0.3) !important;
    }
    </style>
    """, unsafe_allow_html=True)
    
    # ‚úÖ GRID LAYOUT - 3 tlaƒçidl√° na riadok
    buttons_per_row = 3
    total_employees = len(employees)
    
    for row_start in range(0, total_employees, buttons_per_row):
        row_employees = employees[row_start:row_start + buttons_per_row]
        
        # Vytvorenie stƒ∫pcov pre aktu√°lny riadok
        cols = st.columns(len(row_employees))
        
        # Zobrazenie tlaƒçidiel v stƒ∫pcoch
        for col_idx, emp in enumerate(row_employees):
            with cols[col_idx]:
                create_employee_button_in_column(emp, analyzer, row_start + col_idx, prefix)
        
        # Spacing medzi riadkami
        st.markdown("<div style='margin: 1.5rem 0;'></div>", unsafe_allow_html=True)

def create_monthly_activity_chart(analyzer):
    """Vytvor√≠ stƒ∫pcov√Ω graf rozlo≈æenia pracovnej ƒçinnosti po mesiacoch - SKUTOƒåN√â D√ÅTA"""
    
    import plotly.graph_objects as go
    import plotly.express as px
    from datetime import datetime
    
    create_section_header("Rozlo≈æenie pracovnej ƒçinnosti poƒças roka", "üìä")
    
    # ‚úÖ SKUTOƒåN√â D√ÅTA Z ANALYZ√ÅTORA
    monthly_data = {}
    czech_months = ['leden', 'unor', 'brezen', 'duben', 'kveten', 'cerven', 
                   'cervenec', 'srpen', 'zari', 'rijen', 'listopad', 'prosinec']
    
    # Inicializ√°cia mesaƒçn√Ωch s√∫m
    for month in czech_months:
        monthly_data[month] = 0
    
    # ‚úÖ AGREG√ÅCIA SKUTOƒåN√ùCH SALES D√ÅT
    if hasattr(analyzer, 'sales_employees') and analyzer.sales_employees:
        for employee in analyzer.sales_employees:
            if 'monthly_sales' in employee and employee['monthly_sales']:
                for month, sales in employee['monthly_sales'].items():
                    # Konverzia n√°zvov mesiacov ak je potrebn√©
                    month_lower = month.lower()
                    if month_lower in monthly_data:
                        monthly_data[month_lower] += sales
    
    # ‚úÖ FALLBACK - ak nem√°me monthly_sales, pou≈æijeme total_sales rozdelen√©
    if all(value == 0 for value in monthly_data.values()):
        st.info("‚ÑπÔ∏è Mesaƒçn√© d√°ta nie s√∫ dostupn√© - rozdeƒæujem celkov√© predaje rovnomerne")
        
        summary = analyzer.get_all_employees_summary()
        total_sales = sum([emp.get('total_sales', 0) for emp in summary]) if summary else 0
        
        if total_sales > 0:
            # Rozdelenie na 12 mesiacov s miernou vari√°ciou
            base_monthly = total_sales / 12
            import random
            random.seed(42)  # Pre konzistentn√© v√Ωsledky
            
            for i, month in enumerate(czech_months):
                # Pridanie realistickej vari√°cie (¬±20%)
                variation = random.uniform(0.8, 1.2)
                monthly_data[month] = int(base_monthly * variation)
    
    # ‚úÖ ZOBRAZENIE INFO O D√ÅTACH
    total_annual = sum(monthly_data.values())
    if total_annual == 0:
        st.warning("‚ö†Ô∏è ≈Ωiadne sales d√°ta dostupn√©")
        return
    
    # V√Ωber typu grafu
    col1, col2, col3 = st.columns([2, 1, 1])
    
    with col1:
        chart_type = st.selectbox(
            "üìä Typ grafu:",
            ["Stƒ∫pcov√Ω", "ƒåiarov√Ω", "Oblas≈•"],
            key="monthly_chart_type"
        )
    
    with col2:
        show_values = st.checkbox("Zobrazi≈• hodnoty", value=True)
    
    with col3:
        show_trend = st.checkbox("Trend ƒçiara", value=False)
    
    # Vytvorenie grafu
    months_list = list(monthly_data.keys())
    values_list = list(monthly_data.values())
    
    fig = go.Figure()
    
    # Hlavn√Ω graf podƒæa typu
    if chart_type == "Stƒ∫pcov√Ω":
        fig.add_trace(go.Bar(
            x=months_list,
            y=values_list,
            name="Predaj (Kƒç)",
            marker_color='rgba(102, 126, 234, 0.8)',
            text=[f"{v:,.0f} Kƒç" for v in values_list] if show_values else None,
            textposition='auto' if show_values else None,
            hovertemplate="<b>%{x}</b><br>Predaj: %{y:,.0f} Kƒç<extra></extra>"
        ))
    
    elif chart_type == "ƒåiarov√Ω":
        fig.add_trace(go.Scatter(
            x=months_list,
            y=values_list,
            mode='lines+markers',
            name="Predaj (Kƒç)",
            line=dict(color='rgba(102, 126, 234, 0.8)', width=3),
            marker=dict(size=8, color='rgba(102, 126, 234, 1)'),
            text=[f"{v:,.0f} Kƒç" for v in values_list] if show_values else None,
            textposition="top center" if show_values else None,
            hovertemplate="<b>%{x}</b><br>Predaj: %{y:,.0f} Kƒç<extra></extra>"
        ))
    
    else:  # Oblas≈•
        fig.add_trace(go.Scatter(
            x=months_list,
            y=values_list,
            fill='tozeroy',
            name="Predaj (Kƒç)",
            line=dict(color='rgba(102, 126, 234, 0.8)'),
            fillcolor='rgba(102, 126, 234, 0.3)',
            text=[f"{v:,.0f} Kƒç" for v in values_list] if show_values else None,
            textposition="top center" if show_values else None,
            hovertemplate="<b>%{x}</b><br>Predaj: %{y:,.0f} Kƒç<extra></extra>"
        ))
    
    # Trend ƒçiara
    if show_trend:
        import numpy as np
        x_numeric = list(range(len(values_list)))
        z = np.polyfit(x_numeric, values_list, 1)
        p = np.poly1d(z)
        trend_values = [p(x) for x in x_numeric]
        
        fig.add_trace(go.Scatter(
            x=months_list,
            y=trend_values,
            mode='lines',
            name='Trend',
            line=dict(color='red', width=2, dash='dash'),
            hovertemplate="<b>Trend</b><br>%{x}: %{y:,.0f} Kƒç<extra></extra>"
        ))
    
    # Layout nastavenia
    layout_settings = get_dark_plotly_layout()
    layout_settings.update({
        'title': {
            'text': f"üìä Rozlo≈æenie predajnej ƒçinnosti poƒças roka {datetime.now().year}",
            'x': 0.5,
            'font': {'size': 20, 'color': '#fafafa'}
        },
        'xaxis': {
            'title': {
                'text': "Mesiac",
                'font': {'color': '#fafafa'}
            },
            'tickfont': {'color': '#fafafa'},
            'gridcolor': '#262730'
        },
        'yaxis': {
            'title': {
                'text': "Predaj (Kƒç)",
                'font': {'color': '#fafafa'}
            },
            'tickfont': {'color': '#fafafa'},
            'gridcolor': '#262730',
            'tickformat': ',.0f'
        },
        'height': 500,
        'showlegend': True if show_trend else False,
        'hovermode': 'x unified'
    })
    
    fig.update_layout(**layout_settings)
    
    # Zobrazenie grafu
    st.plotly_chart(fig, use_container_width=True)
    
    # ‚úÖ SKUTOƒåN√â ≈†TATISTIKY POD GRAFOM
    col1, col2, col3, col4 = st.columns(4)
    
    total_sales = sum(values_list)
    avg_monthly = total_sales / 12
    best_month_idx = values_list.index(max(values_list))
    worst_month_idx = values_list.index(min(values_list))
    
    with col1:
        st.metric(
            "üí∞ Celkov√Ω predaj",
            f"{total_sales:,.0f} Kƒç",
            help="S√∫ƒçet skutoƒçn√©ho predaja za v≈°etky mesiace"
        )
    
    with col2:
        st.metric(
            "üìä Mesaƒçn√Ω priemer",
            f"{avg_monthly:,.0f} Kƒç",
            help="Priemern√Ω skutoƒçn√Ω predaj za mesiac"
        )
    
    with col3:
        st.metric(
            "üèÜ Najlep≈°√≠ mesiac",
            f"{months_list[best_month_idx].title()}",
            f"{values_list[best_month_idx]:,.0f} Kƒç",
            help="Mesiac s najvy≈°≈°√≠m skutoƒçn√Ωm predajom"
        )
    
    with col4:
        st.metric(
            "üìâ Najslab≈°√≠ mesiac", 
            f"{months_list[worst_month_idx].title()}",
            f"{values_list[worst_month_idx]:,.0f} Kƒç",
            delta_color="inverse",
            help="Mesiac s najni≈æ≈°√≠m skutoƒçn√Ωm predajom"
        )

def create_activity_breakdown_chart(analyzer):
    """Vytvor√≠ rozlo≈æenie aktiv√≠t pou≈æ√≠vaj√∫c utils funkcie - SKUTOƒåN√â D√ÅTA"""
    
    create_section_header("Detailn√© rozlo≈æenie aktiv√≠t", "üéØ")
    
    # ‚úÖ POU≈ΩITIE UTILITY FUNKCI√ç Z core/utils.py
    activity_data = calculate_activity_breakdown(analyzer)
    
    if not activity_data:
        st.warning("‚ö†Ô∏è Nie je mo≈æn√© vypoƒç√≠ta≈• rozlo≈æenie aktiv√≠t")
        return
    
    # ‚úÖ NOV√ù - Kombinovan√Ω mesaƒçn√Ω graf pou≈æ√≠vaj√∫c utils funkciu
        create_subsection_header("Mesaƒçn√© rozlo≈æenie v≈°etk√Ωch aktiv√≠t", "üìä")    # Vytvorenie grafu z utils
    fig = create_combined_monthly_activity_chart(analyzer, activity_data)
    
    if fig:
        # Layout nastavenia
        from ui.styling import get_dark_plotly_layout
        
        layout_settings = get_dark_plotly_layout()
        layout_settings.update({
            'title': {
                'text': "üìä Mesaƒçn√© rozlo≈æenie aktiv√≠t - Internet + Aplik√°cie",
                'x': 0.5,
                'font': {'size': 18, 'color': '#fafafa'}
            },
            'barmode': 'stack',
            'xaxis': {
                'title': {'text': "Mesiac", 'font': {'color': '#fafafa'}},
                'tickfont': {'color': '#fafafa'}
            },
            'yaxis': {
                'title': {'text': "Hodiny", 'font': {'color': '#fafafa'}},
                'tickfont': {'color': '#fafafa'}
            },
            'height': 500,
            'legend': {
                'orientation': "v",
                'yanchor': "top",
                'y': 1,
                'xanchor': "left",
                'x': 1.02,
                'bgcolor': 'rgba(0,0,0,0.5)',
                'bordercolor': '#333',
                'borderwidth': 1
            }
        })
        
        fig.update_layout(**layout_settings)
        st.plotly_chart(fig, use_container_width=True)
        
        # S√∫hrnn√© ≈°tatistiky pou≈æ√≠vaj√∫c utils
        display_monthly_summary_from_utils(activity_data)
    else:
        st.error("‚ùå Nepodarilo sa vytvori≈• graf aktiv√≠t")
    
    st.markdown("---")
    
    # Kontrola ovl√°dac√≠ch prvkov (existuj√∫ci k√≥d pre pie charts, bar charts, atƒè.)
    col1, col2, col3 = st.columns([2, 1, 1])
    
    with col1:
        view_type = st.selectbox(
            "üìä Typ zobrazenia:",
            ["Pie Charts", "Bar Chart", "Kateg√≥rie"],
            key="activity_view_type"
        )
    
    with col2:
        data_source = st.selectbox(
            "üîç Zdroj d√°t:",
            ["Kombinovan√©", "Internet aktivity", "Aplikaƒçn√© aktivity"],
            key="activity_data_source"
        )
    
    with col3:
        show_metrics = st.checkbox("Produktivitn√© metriky", value=True)
    
    # Zobrazenie podƒæa v√Ωberu
    if view_type == "Pie Charts":
        display_activity_pie_charts(activity_data, data_source)
    elif view_type == "Bar Chart":
        display_activity_bar_chart(activity_data, data_source)
    else:  # Kateg√≥rie
        display_activity_categories(activity_data)
    
    # Produktivitn√© metriky
    if show_metrics:
        display_productivity_metrics(activity_data)
def display_monthly_summary_from_utils(activity_data):
    """Zobraz√≠ s√∫hrn pou≈æ√≠vaj√∫c utils funkciu"""
    
    create_subsection_header("S√∫hrn mesaƒçn√Ωch aktiv√≠t", "üìà")
    
    # Z√≠skanie s√∫hrnu z utils funkcie
    summary = get_combined_monthly_activity_summary(activity_data)
    
    if not summary:
        st.warning("‚ö†Ô∏è Nie je mo≈æn√© vypoƒç√≠ta≈• s√∫hrn aktiv√≠t")
        return
    
    # Hlavn√© metriky
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        internet_percentage = f"{(summary['total_internet']/summary['total_combined'])*100:.1f}%" if summary['total_combined'] > 0 else "0%"
        st.metric(
            "üåê Internet celkom",
            f"{summary['total_internet']:.1f}h",
            internet_percentage
        )
    
    with col2:
        app_percentage = f"{(summary['total_apps']/summary['total_combined'])*100:.1f}%" if summary['total_combined'] > 0 else "0%"
        st.metric(
            "üíª Aplik√°cie celkom",
            f"{summary['total_apps']:.1f}h", 
            app_percentage
        )
    
    with col3:
        st.metric(
            "‚è±Ô∏è Celkov√Ω ƒças",
            f"{summary['total_combined']:.1f}h",
            help="S√∫ƒçet v≈°etk√Ωch internetov√Ωch a aplikaƒçn√Ωch aktiv√≠t"
        )
    
    with col4:
        st.metric(
            "üìä Mesaƒçn√Ω priemer",
            f"{summary['avg_monthly']:.1f}h",
            help="Priemern√Ω ƒças aktiv√≠t za mesiac"
        )
    
    # Detailn√© inform√°cie v dvoch stƒ∫pcoch
    col1, col2 = st.columns(2)
    
    with col1:
        st.markdown("**üèÜ Top 5 aktiv√≠t:**")
        if summary['top_activities']:
            for i, activity in enumerate(summary['top_activities']):
                percentage = (activity['hours'] / summary['total_combined'] * 100) if summary['total_combined'] > 0 else 0
                st.write(f"{i+1}. {activity['name']}: {activity['hours']:.1f}h ({percentage:.1f}%)")
        else:
            st.write("≈Ωiadne aktivity dostupn√©")
    
    with col2:
        st.markdown("**üìä Produktivita:**")
        if summary['total_combined'] > 0:
            prod_pct = (summary['productive_hours'] / summary['total_combined']) * 100
            unprod_pct = (summary['unproductive_hours'] / summary['total_combined']) * 100
            
            st.write(f"üü¢ Produkt√≠vne: {summary['productive_hours']:.1f}h ({prod_pct:.1f}%)")
            st.write(f"üî¥ Neprodukt√≠vne: {summary['unproductive_hours']:.1f}h ({unprod_pct:.1f}%)")
            
            # Produktivitn√© sk√≥re s farbou podƒæa v√Ωkonnosti
            productivity_score = summary['productivity_score']
            if productivity_score >= 70:
                color = "üü¢"
            elif productivity_score >= 50:
                color = "üü°"
            else:
                color = "üî¥"
            
            st.metric(
                "üìä Produktivitn√© sk√≥re", 
                f"{color} {productivity_score:.1f}%",
                help="Podiel produkt√≠vnych aktiv√≠t ku celkov√©mu ƒçasu"
            )
        else:
            st.write("≈Ωiadne d√°ta o produktivite")
    
    # Dodatoƒçn√© inform√°cie
    if summary['total_combined'] > 0:
        st.markdown("---")
        col1, col2, col3 = st.columns(3)
        
        with col1:
            # Najprodukt√≠vnej≈°ia aktivita
            if summary['top_activities']:
                top_activity = summary['top_activities'][0]
                st.info(f"ü•á **Najakt√≠vnej≈°ia**: {top_activity['name']} ({top_activity['hours']:.1f}h)")
        
        with col2:
            # Pomer internet vs aplik√°cie
            if summary['total_internet'] > summary['total_apps']:
                st.info(f"üåê **Dominuje**: Internet aktivity")
            elif summary['total_apps'] > summary['total_internet']:
                st.info(f"üíª **Dominuje**: Aplikaƒçn√© aktivity")
            else:
                st.info(f"‚öñÔ∏è **Vyrovnan√©**: Internet vs Aplik√°cie")
        
        with col3:
            # Denn√Ω priemer
            daily_avg = summary['avg_monthly'] / 30  # Pribli≈æne 30 dn√≠ v mesiaci
            st.info(f"üìÖ **Denn√Ω priemer**: {daily_avg:.1f}h")


def display_activity_pie_charts(activity_data, data_source):
    """Zobraz√≠ pie charty pre aktivity pou≈æ√≠vaj√∫c utils"""
    import plotly.graph_objects as go
    from ui.styling import get_dark_plotly_layout
    
    colors = get_activity_colors()
    
    if data_source == "Kombinovan√©":
        col1, col2 = st.columns(2)
        
        with col1:
            create_single_pie_chart(
                activity_data['internet'], 
                "üåê Internetov√© aktivity",
                colors['internet']
            )
        
        with col2:
            create_single_pie_chart(
                activity_data['applications'], 
                "üíª Aplikaƒçn√© aktivity", 
                colors['applications']
            )
    elif data_source == "Internet aktivity":
        create_single_pie_chart(
            activity_data['internet'], 
            "üåê Internetov√© aktivity",
            colors['internet']
        )
    else:  # Aplikaƒçn√© aktivity
        create_single_pie_chart(
            activity_data['applications'], 
            "üíª Aplikaƒçn√© aktivity",
            colors['applications']
        )

def create_single_pie_chart(data_dict, title, colors):
    """Vytvor√≠ jeden pie chart"""
    import plotly.graph_objects as go
    from ui.styling import get_dark_plotly_layout
    
    if not data_dict['percentages']:
        st.info(f"‚ÑπÔ∏è ≈Ωiadne d√°ta pre {title}")
        return
    
    activities = list(data_dict['percentages'].keys())
    percentages = list(data_dict['percentages'].values())
    hours = [data_dict['hours'][act] for act in activities]
    
    activity_colors = [colors.get(act, '#6b7280') for act in activities]
    
    fig = go.Figure(data=[go.Pie(
        labels=activities,
        values=percentages,
        hole=0.3,
        marker_colors=activity_colors,
        hovertemplate="<b>%{label}</b><br>" +
                      "ƒåas: %{customdata:.1f}h<br>" +
                      "Podiel: %{percent}<br>" +
                      "<extra></extra>",
        customdata=hours
    )])
    
    layout_settings = get_dark_plotly_layout()
    layout_settings.update({
        'title': {
            'text': title,
            'x': 0.5,
            'font': {'size': 16, 'color': '#fafafa'}
        },
        'height': 400,
        'showlegend': True,
        'legend': {
            'orientation': "v",
            'yanchor': "middle", 
            'y': 0.5,
            'xanchor': "left",
            'x': 1.05
        }
    })
    
    fig.update_layout(**layout_settings)
    st.plotly_chart(fig, use_container_width=True)

def display_activity_bar_chart(activity_data, data_source):
    """Zobraz√≠ bar chart pre aktivity"""
    import plotly.graph_objects as go
    from ui.styling import get_dark_plotly_layout
    
    fig = go.Figure()
    
    if data_source == "Kombinovan√©":
        # Pridanie internet aktiv√≠t
        if activity_data['internet']['hours']:
            internet_activities = list(activity_data['internet']['hours'].keys())
            internet_values = list(activity_data['internet']['hours'].values())
            
            fig.add_trace(go.Bar(
                name="Internet aktivity",
                x=internet_activities,
                y=internet_values,
                marker_color='rgba(102, 126, 234, 0.8)',
                hovertemplate="<b>%{x}</b><br>ƒåas: %{y:.1f}h<extra></extra>"
            ))
        
        # Pridanie aplikaƒçn√Ωch aktiv√≠t
        if activity_data['applications']['hours']:
            app_activities = list(activity_data['applications']['hours'].keys())
            app_values = list(activity_data['applications']['hours'].values())
            
            fig.add_trace(go.Bar(
                name="Aplikaƒçn√© aktivity",
                x=app_activities,
                y=app_values,
                marker_color='rgba(244, 114, 182, 0.8)',
                hovertemplate="<b>%{x}</b><br>ƒåas: %{y:.1f}h<extra></extra>"
            ))
    
    elif data_source == "Internet aktivity":
        if activity_data['internet']['hours']:
            activities = list(activity_data['internet']['hours'].keys())
            values = list(activity_data['internet']['hours'].values())
            colors_list = [get_activity_colors()['internet'].get(act, '#6b7280') for act in activities]
            
            fig.add_trace(go.Bar(
                x=activities,
                y=values,
                marker_color=colors_list,
                hovertemplate="<b>%{x}</b><br>ƒåas: %{y:.1f}h<extra></extra>"
            ))
    
    else:  # Aplikaƒçn√© aktivity
        if activity_data['applications']['hours']:
            activities = list(activity_data['applications']['hours'].keys())
            values = list(activity_data['applications']['hours'].values())
            colors_list = [get_activity_colors()['applications'].get(act, '#6b7280') for act in activities]
            
            fig.add_trace(go.Bar(
                x=activities,
                y=values,
                marker_color=colors_list,
                hovertemplate="<b>%{x}</b><br>ƒåas: %{y:.1f}h<extra></extra>"
            ))
    
    # Layout nastavenia
    layout_settings = get_dark_plotly_layout()
    layout_settings.update({
        'title': {
            'text': f"üìä {data_source} - ƒåasov√© rozlo≈æenie",
            'x': 0.5,
            'font': {'size': 18, 'color': '#fafafa'}
        },
        'barmode': 'group',
        'xaxis': {
            'title': {
                'text': "Aktivita",
                'font': {'color': '#fafafa'}
            },
            'tickfont': {'color': '#fafafa'},
            'tickangle': -45
        },
        'yaxis': {
            'title': {
                'text': "ƒåas (hodiny)",
                'font': {'color': '#fafafa'}
            },
            'tickfont': {'color': '#fafafa'}
        },
        'height': 500,
        'showlegend': data_source == "Kombinovan√©"
    })
    
    fig.update_layout(**layout_settings)
    st.plotly_chart(fig, use_container_width=True)

def display_activity_categories(activity_data):
    """Zobraz√≠ aktivity rozdelen√© do kateg√≥ri√≠ pou≈æ√≠vaj√∫c utils"""
    
    categorized = categorize_activities(activity_data)
    
    col1, col2, col3, headers = create_three_column_layout()
    
    with col1:
        create_subsection_header("Produkt√≠vne aktivity", "üü¢")
        total_productive = categorized['productive']['hours']
        create_simple_metric_card("Celkov√Ω ƒças", f"{total_productive:.1f}h", color=headers['col1'][1])
        
        for activity in categorized['productive']['activities']:
            st.write(f"‚Ä¢ {activity['name']}: {activity['hours']:.1f}h")
    
    with col2:
        create_subsection_header("Neutr√°lne aktivity", "üîµ")
        total_neutral = categorized['neutral']['hours']
        create_simple_metric_card("Celkov√Ω ƒças", f"{total_neutral:.1f}h", color=headers['col2'][1])
        
        for activity in categorized['neutral']['activities']:
            st.write(f"‚Ä¢ {activity['name']}: {activity['hours']:.1f}h")
    
    with col3:
        create_subsection_header("Kritick√© aktivity", "üî¥")
        total_unproductive = categorized['unproductive']['hours']
        create_simple_metric_card("Celkov√Ω ƒças", f"{total_unproductive:.1f}h", color=headers['col3'][1])
        
        for activity in categorized['unproductive']['activities']:
            st.write(f"‚Ä¢ {activity['name']}: {activity['hours']:.1f}h")

def display_productivity_metrics(activity_data):
    """Zobraz√≠ produktivitn√© metriky pou≈æ√≠vaj√∫c utils"""
    
    metrics = calculate_productivity_metrics(activity_data)
    top_activities = get_top_activities(activity_data, limit=3)
    
    create_section_header("Produktivitn√© metriky", "üìà")
    
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        st.metric(
            "üéØ Produktivita",
            f"{metrics['productivity_score']}%",
            help="Podiel produkt√≠vnych aktiv√≠t ku celkov√©mu ƒçasu"
        )
    
    with col2:
        st.metric(
            "‚öñÔ∏è Efektivitn√Ω pomer",
            f"{metrics['efficiency_ratio']}:1",
            help="Pomer produkt√≠vnych ku neprodukt√≠vnym aktivit√°m"
        )
    
    with col3:
        st.metric(
            "üéØ Focus ƒças",
            f"{metrics['focus_time']:.1f}h",
            help="ƒåas str√°ven√Ω hlavn√Ωmi produkt√≠vnymi aktivitami"
        )
    
    with col4:
        st.metric(
            "‚è±Ô∏è Celkov√Ω ƒças",
            f"{metrics['total_hours']:.1f}h",
            help="Celkov√Ω sledovan√Ω ƒças"
        )
    
    # Top aktivity
    col1, col2 = st.columns(2)
    
    with col1:
        create_subsection_header("Top Internet aktivity", "üèÜ")
        for activity in top_activities['internet']:
            st.write(f"‚Ä¢ **{activity['name']}**: {activity['hours']:.1f}h ({activity['percentage']:.1f}%)")
    
    with col2:
        create_subsection_header("Top Aplikaƒçn√© aktivity", "üèÜ")
        for activity in top_activities['applications']:
            st.write(f"‚Ä¢ **{activity['name']}**: {activity['hours']:.1f}h ({activity['percentage']:.1f}%)")

# ========== ZVY≈†OK FUNKCI√ç ZOST√ÅVA ROVNAK√ù ==========

def create_employee_button_in_column(emp, analyzer, index, prefix):
    """Vytvor√≠ tlaƒçidlo zamestnanca v stƒ∫pci"""
    
    name = emp.get('name', 'Unknown')
    workplace = emp.get('workplace', 'Nezn√°me')
    
    # Sales data
    actual_profit = find_correct_sales_data(name, emp, analyzer)
    emp['total_sales'] = actual_profit
    
    # Metriky
    metrics = calculate_real_employee_metrics(emp, analyzer)
    
    unique_key = f"{prefix}_col_{index}_{name.replace(' ', '_').replace('.', '')}"
    
    # ‚úÖ OPRAVEN√â: Kompaktn√© farebn√© metriky s KONZISTENTN√ùMI prahmani
    metric_compact = []
    metric_order = [('sales', 'üí∞'), ('mail', 'üìß'), ('sketchup', 'üíª'), ('internet', 'üåê'), ('overall', '‚≠ê')]
    
    for key, emoji in metric_order:
        if key in metrics:
            value = metrics[key]['value']
            
            # ‚úÖ KONZISTENTN√â prahy pre v≈°etky metriky
            if value >= 80:
                color = "üü¢"  # Zelen√Ω - v√Ωborn√©
            elif value >= 60:
                color = "üü°"  # ≈Ωlt√Ω - dobr√©
            elif value >= 40:
                color = "üü†"  # Oran≈æov√Ω - priemern√©  
            else:
                color = "üî¥"  # ƒåerven√Ω - zl√©
            
            metric_compact.append(f"{color}{emoji}{value:.0f}")
    
    # Skr√°tenie dlh√Ωch mien
    short_name = name if len(name) <= 12 else name[:9] + "..."
    short_workplace = workplace[:6].title() if len(workplace) > 6 else workplace.title()
    
    # Rozdelenie metr√≠k na 2 riadky
    first_line = "  ".join(metric_compact[:3])
    second_line = "  ".join(metric_compact[3:])
    
    # Button text
    button_text = f"üë§ {short_name}\nüìç {short_workplace} | üí∞{actual_profit/1000:.0f}K\n{first_line}"
    if second_line:
        button_text += f"\n{second_line}"
    
    is_selected = st.session_state.get('selected_employee') == name
    
    # TLAƒåIDLO
    if st.button(
        button_text,
        key=unique_key,
        use_container_width=True,
        type="primary" if is_selected else "secondary",
        help=f"üìä {name}\nüè¢ {workplace.title()}\nüí∞ Predaj: {actual_profit:,.0f} Kƒç\n\n" +
             f"üíª SketchUp: {metrics.get('sketchup', {}).get('value', 0):.0f}% " + 
             f"({'Nepou≈æ√≠va' if metrics.get('sketchup', {}).get('value', 0) >= 80 else 'Pou≈æ√≠va ƒçasto'})"
    ):
        # ‚úÖ BEZPEƒåNOSTN√Å KONTROLA - overenie opr√°vnen√≠ k mestu
        from auth.auth import can_access_city
        
        if can_access_city(workplace):
            st.session_state.selected_employee = name
            st.session_state.current_page = 'employee'
            st.rerun()
        else:
            st.error(f"‚ùå Nem√°te opr√°vnenie prist√∫pi≈• k zamestnancovi z mesta: {workplace.title()}")
            st.warning("üîí Kontaktujte administr√°tora pre roz≈°√≠renie opr√°vnen√≠")

def find_correct_sales_data(employee_name, emp, analyzer):
    """Automaticky n√°jde spr√°vne sales d√°ta zo v≈°etk√Ωch zdrojov"""
    
    sales_candidates = []
    
    # 1. Z emp objektu monthly_sales
    if 'monthly_sales' in emp and emp['monthly_sales']:
        monthly_total = sum(emp['monthly_sales'].values())
        sales_candidates.append(('monthly_sales', monthly_total))
    
    # 2. Z emp objektu total_sales
    if emp.get('total_sales', 0) > 0:
        total_sales = emp.get('total_sales')
        sales_candidates.append(('total_sales', total_sales))
    
    # 3. Z analyzer.sales_employees
    if hasattr(analyzer, 'sales_employees'):
        for sales_emp in analyzer.sales_employees:
            if sales_emp.get('name') == employee_name:
                if 'monthly_sales' in sales_emp and sales_emp['monthly_sales']:
                    analyzer_total = sum(sales_emp['monthly_sales'].values())
                    sales_candidates.append(('analyzer_monthly', analyzer_total))
                break
    
    # Anal√Ωza a v√Ωber spr√°vnej hodnoty
    if not sales_candidates:
        return 0
    
    if len(sales_candidates) == 1:
        chosen_source, chosen_value = sales_candidates[0]
        return chosen_value
    
    # Viac zdrojov - uprednostni≈• monthly_sales
    for source, value in sales_candidates:
        if source in ['monthly_sales', 'analyzer_monthly']:
            return value
    
    # Fallback na prv√Ω zdroj
    chosen_source, chosen_value = sales_candidates[0]
    
    return chosen_value

def show_neutral_legend():
    """Zobraz√≠ neutr√°lnu legendu bez farieb"""
    
    create_section_header("Legenda metr√≠k", "üìä")
    
    # Jednoduch√° textov√° legenda bez farieb
    col1, col2, col3, col4, col5 = st.columns(5)
    
    with col1:
        st.markdown("**üí∞ Predaj**")
        st.caption("Predajn√° v√Ωkonnos≈•")
    
    with col2:
        st.markdown("**üìß Mail**") 
        st.caption("Efektivita mailov")
    
    with col3:
        st.markdown("**üíª SketchUp**")
        st.caption("Pou≈æ√≠vanie programu")
    
    with col4:
        st.markdown("**üåê Internet**")
        st.caption("Internetov√° aktivita")
    
    with col5:
        st.markdown("**‚≠ê Celkov√©**")
        st.caption("Celkov√© hodnotenie")

def calculate_real_employee_metrics(emp, analyzer):
    """Pou≈æ√≠va metrics calculator s opraven√Ωmi overall scores"""
    
    employee_name = emp.get('name', '')
    
    # ‚úÖ OPRAVEN√â: V√Ωpoƒçet sales z monthly_sales ak total_sales ch√Ωba
    if emp.get('total_sales', 0) == 0 and 'monthly_sales' in emp:
        sales = sum(emp['monthly_sales'].values()) if emp['monthly_sales'] else 0
        emp['total_sales'] = sales
    else:
        sales = emp.get('total_sales', 0)
    
    # Vytvorenie calculator objektu
    calculator = EmployeeMetricsCalculator(analyzer)
    
    # V√Ωpoƒçty
    sales_score = calculator.calculate_sales_score(sales)
    
    # Ostatn√© metriky
    try:
        mail_score = calculator.calculate_mail_efficiency(employee_name, sales)
    except Exception as e:
        mail_score = 65
    
    try:
        sketchup_score = calculator.calculate_sketchup_usage(employee_name)
    except Exception as e:
        sketchup_score = 90
    
    try:
        internet_score = calculator.calculate_internet_efficiency(employee_name)
    except Exception as e:
        internet_score = 60
    
    # ‚úÖ OPRAVEN√â: N√°js≈• p√¥vodn√Ω overall score z analyz√°tora
    overall_score = find_original_overall_score(employee_name, analyzer)
    
    return {
        'sales': {'value': sales_score},
        'mail': {'value': mail_score},
        'sketchup': {'value': sketchup_score},
        'internet': {'value': internet_score},
        'overall': {'value': overall_score}
    }

def find_original_overall_score(employee_name, analyzer):
    """N√°jde p√¥vodn√Ω overall score z analyz√°tora"""
    
    # Hƒæadanie v sales_employees
    if hasattr(analyzer, 'sales_employees'):
        for emp in analyzer.sales_employees:
            if emp.get('name') == employee_name:
                score = emp.get('score', 0)
                if score > 0:
                    return score
    
    # Fallback
    return 50
